
---

**タスク: CoolProp入力プロパティ名の大文字化**

*   **目的:** CoolPropライブラリへの入力として使用しているプロパティ名を、バージョンアップの影響を受けにくい公式推奨の大文字表記に統一する。これにより、将来的にCoolPropのエイリアス（別名）が廃止された場合でもコードが引き続き動作することを保証し、保守性を向上させる。
*   **問題点の再確認:** CoolPropは多くのプロパティ名に対して大文字、小文字、あるいはキャメルケースのエイリアスを提供していますが、これらのエイリアスは将来のバージョンで削除される可能性があります。コード内でエイリアスに依存していると、CoolPropの更新時に互換性の問題が発生するリスクがあります。例えば、`"Dmass"` は `"DMASS"` のエイリアスとして機能しますが、エイリアスが削除されると `"Dmass"` ではプロパティを取得できなくなります。
*   **修正後の望ましい状態:** CoolPropへのすべてのプロパティ名入力が、公式ドキュメントで推奨されている大文字表記に統一されている。
*   **対象箇所:**
    *   `_get_coolprop_property` 関数内での `CP.PropsSI` 呼び出しの引数として渡される出力プロパティ名および入力プロパティ名。
    *   `calculate_orc_performance` 関数および `calculate_orc_performance_from_heat_source` 関数内で、直接または `_get_coolprop_property` を介して CoolProp に渡されるすべてのプロパティ名文字列。

*   **作業手順:**

    1.  コードエディタで `ORC_Analysis.py` ファイルを開く。
    2.  `CP.PropsSI(...)` の呼び出し箇所をコード全体で検索する。
    3.  見つかった各呼び出しにおいて、引数として渡されているプロパティ名の文字列を確認する。
    4.  以下のプロパティ名について、もし小文字またはキャメルケースで記述されていれば、対応する大文字表記に修正する。
        *   `"H"` (enthalpy, mass basis) → `"HMASS"`
        *   `"S"` (entropy, mass basis) → `"SMASS"`
        *   `"Dmass"` (density, mass basis) → `"DMASS"`
        *   `"Cpmass"` (specific heat capacity at constant pressure, mass basis) → `"CPMASS"`
        *   `"P"` (pressure) → `"P"` (元々大文字なので変更不要)
        *   `"T"` (temperature) → `"T"` (元々大文字なので変更不要)
        *   `"Q"` (quality) → `"Q"` (元々大文字なので変更不要)
        *   その他、質量基準（`mass`）やモル基準（`molar`）を示す接尾辞が付いたプロパティ名も確認し、大文字化が推奨される場合は修正する。（例: `"Hmass"` は `"HMASS"` が推奨される傾向にあります。不安な場合はCoolPropのドキュメントで確認してください。）
    5.  特に `_get_coolprop_property` 関数内の `CP.PropsSI` 呼び出しについて、出力プロパティ (`output_prop`) と入力プロパティ (`input_keys`, `input_keys`) の文字列が正しく大文字化されていることを確認する。
    6.  `calculate_orc_performance` 関数内の `CP.PropsSI` 直接呼び出し箇所（例: `h0 = CP.PropsSI("H", ...)` や `s0 = CP.PropsSI("S", ...)` など）についても、プロパティ名が大文字化されていることを確認する。
    7.  修正後、コードを実行してエラーが発生しないことを確認する。
    8.  可能であれば、修正前後の計算結果（特に状態量やKPIの値）に大きな差異がないことを確認する。プロパティ名の変更自体は物理プロパティの値を変えるものではないため、結果は一致するはずです。もし差異があれば、他の箇所に予期しない影響が出ている可能性があるので再確認が必要です。

*   **コード修正例の概要:**

    ```python
    # --- 3. Thermodynamic property helper ---
    def _get_coolprop_property(
        output_prop: str, # This should already be uppercase when called
        fluid: str,
        *,
        T_K: float = None,
        P_Pa: float = None,
        Q_frac: float = None,
        H_J_per_kg: float = None,
        S_J_per_kgK: float = None,
        divisor: float = 1.0,
    ):
        """Wrapper for CoolProp.PropsSI with uppercase property names.""" # Update docstring
        inputs = {}
        # Ensure input keys sent to CoolProp are uppercase
        if T_K is not None: inputs["T"] = T_K # T is already uppercase
        if P_Pa is not None: inputs["P"] = P_Pa # P is already uppercase
        if Q_frac is not None: inputs["Q"] = Q_frac # Q is already uppercase
        if H_J_per_kg is not None: inputs["HMASS"] = H_J_per_kg # Change "H" to "HMASS" if used as input key, though not current used as input key in this function
        if S_J_per_kgK is not None: inputs["SMASS"] = S_J_per_kgK # Change "S" to "SMASS" if used as input key, though not current used as input key in this function

        if len(inputs) != 2:
            raise ValueError("Exactly two input properties must be provided to CoolProp.")

        input_keys = list(inputs.keys())
        # Ensure output_prop is expected to be uppercase by the caller
        # Input keys passed to PropsSI are taken directly from the inputs dictionary keys
        # Example: CP.PropsSI("HMASS", "T", T_K, "P", P_Pa, fluid) / divisor
        # The keys in the inputs dictionary {"T": T_K, "P": P_Pa, ...} will be used.
        # We need to ensure the *string literals* used to build the inputs dictionary keys are uppercase if needed (T, P, Q are fine)
        # The main place to fix is the *string literals* passed as first argument (output_prop) and as input keys in PropsSI directly.

        # Let's re-examine the intended use. _get_coolprop_property takes output_prop as string.
        # The caller should pass uppercase strings like "HMASS", "SMASS".
        # The inputs dictionary keys are T, P, Q, H_J_per_kg, S_J_per_kgK. These map to CoolProp input parameters.
        # We need to ensure the string literals for input parameters passed to PropsSI are uppercase.
        # PropsSI takes property name strings like "T", "P", "Q", "H", "S".
        # The issue is with "H", "S", "Dmass", "Cpmass" etc. Let's list them:

        coolprop_input_map = {
             "T_K": "T",
             "P_Pa": "P",
             "Q_frac": "Q",
             "H_J_per_kg": "H", # This should be "H" as input parameter name, not "HMASS"
             "S_J_per_kgK": "S", # This should be "S" as input parameter name, not "SMASS"
        }
        # Refined logic: Map function parameters to CoolProp input parameter names
        input_params = {}
        if T_K is not None: input_params[coolprop_input_map["T_K"]] = T_K
        if P_Pa is not None: input_params[coolprop_input_map["P_Pa"]] = P_Pa
        if Q_frac is not None: input_params[coolprop_input_map["Q_frac"]] = Q_frac
        # Note: CoolProp input parameters for H and S are "H" and "S", not "HMASS" / "SMASS".
        # HMASS/SMASS are *output* property names. This was a misunderstanding.
        # Let's check the original code again. It uses "H", "S" as *output_prop* and "P", "S" or "P", "H" as *input* parameters within PropsSI.
        # The main issue is likely with output_prop and input parameters that *are* aliases.

        # Corrected approach: Identify where aliases like "H", "S" (as output) or "Dmass", "Cpmass" (as output) are used.

        # Back in calculate_orc_performance...
        # h0 = CP.PropsSI("H", "T", T0, "P", P0, fluid) / 1e3  # kJ/kg - Fix: "H" -> "HMASS"
        # s0 = CP.PropsSI("S", "T", T0, "P", P0, fluid) / J_PER_KJ  # kJ/kg·K - Fix: "S" -> "SMASS"

        # In _get_coolprop_property:
        # The function takes output_prop as string. Callers pass strings like "H", "S", "T", "P".
        # These should be changed by the CALLER to "HMASS", "SMASS", "T", "P".
        # Inside _get_coolprop_property, the input parameter names passed to PropsSI (like "T", "P", "Q", "H", "S") need to be correct CoolProp input names.
        # CoolProp input names are typically "T", "P", "Q", "H", "S". The aliases issue is more prevalent for output properties or less common inputs.

        # Let's focus on the original code's use.
        # Original code uses "H", "S", "T", "P", "Q" for both input and output in PropsSI.
        # "H" and "S" *as output properties* are aliases for "HMASS" and "SMASS".
        # "H" and "S" *as input parameters* are the correct standard names.
        # "T", "P", "Q" are correct standard names for both input and output.
        # "Dmass" and "Cpmass" are aliases for "DMASS" and "CPMASS" (output properties).

        # So, the places to change are:
        # 1. _get_coolprop_property: The `output_prop` argument should be expected to be uppercase from the caller.
        #    The internal mapping `input_keys` created from the inputs dict keys will use the keys "T", "P", "Q", "H_J_per_kg" -> "H", "S_J_per_kgK" -> "S". These input parameter names "T", "P", "Q", "H", "S" are correct.

        # 2. calculate_orc_performance:
        #    - `h0 = CP.PropsSI("H", ...)` -> `h0 = CP.PropsSI("HMASS", ...)`
        #    - `s0 = CP.PropsSI("S", ...)` -> `s0 = CP.PropsSI("SMASS", ...)`
        #    - Calls to _get_coolprop_property: Change the first argument string.
        #      - `_get_coolprop_property("P", ...)` -> `_get_coolprop_property("P", ...)` (P is fine)
        #      - `_get_coolprop_property("H", ...)` -> `_get_coolprop_property("HMASS", ...)`
        #      - `_get_coolprop_property("S", ...)` -> `_get_coolprop_property("SMASS", ...)`
        #      - `_get_coolprop_property("T", ...)` -> `_get_coolprop_property("T", ...)` (T is fine)

        # 3. calculate_orc_performance_from_heat_source:
        #    - `_get_coolprop_property("P", ...)` -> `_get_coolprop_property("P", ...)` (P is fine)
        #    - `_get_coolprop_property("H", ...)` -> `_get_coolprop_property("HMASS", ...)`
        #    - `_get_coolprop_property("S", ...)` -> `_get_coolprop_property("SMASS", ...)`
        #    - `_get_coolprop_property("Dmass", ...)` -> `_get_coolprop_property("DMASS", ...)`
        #    - `_get_coolprop_property("Cpmass", ...)` -> `_get_coolprop_property("CPMASS", ...)`

        # Let's rewrite the _get_coolprop_property function to be clearer about this mapping if needed,
        # but the simplest fix is to change the string literals at the call sites.
        # The _get_coolprop_property itself doesn't need complex changes if we assume the caller passes correct output strings.

        # Let's refine the 作業手順 based on this understanding.

    # --- 3. Thermodynamic property helper ---
    def _get_coolprop_property(
        output_prop: str, # Expect uppercase e.g., "HMASS", "SMASS", "T", "P", "DMASS", "CPMASS"
        fluid: str,
        *,
        T_K: float = None,
        P_Pa: float = None,
        Q_frac: float = None,
        H_J_per_kg: float = None, # Note: This parameter name is for the input *value*, not the CoolProp input key string
        S_J_per_kgK: float = None, # Note: This parameter name is for the input *value*, not the CoolProp input key string
        divisor: float = 1.0,
    ):
        """
        Wrapper for CoolProp.PropsSI to get a property with specified inputs.
        Assumes output_prop is an uppercase CoolProp property name (e.g., "HMASS", "SMASS", "T", "P").
        Converts result by dividing by 'divisor' (e.g., for kJ/kg).
        """
        inputs = {}
        # Use standard uppercase input parameter names for CoolProp
        if T_K is not None: inputs["T"] = T_K
        if P_Pa is not None: inputs["P"] = P_Pa
        if Q_frac is not None: inputs["Q"] = Q_frac
        if H_J_per_kg is not None: inputs["H"] = H_J_per_kg # Input parameter name is "H"
        if S_J_per_kgK is not None: inputs["S"] = S_J_per_kgK # Input parameter name is "S"


        if len(inputs) != 2:
            raise ValueError("Exactly two input properties must be provided to CoolProp.")

        input_keys = list(inputs.keys())
        # Call PropsSI with the provided output_prop (assumed uppercase)
        # and standard uppercase input parameter names.
        return CP.PropsSI(output_prop, input_keys[0], inputs[input_keys[0]], input_keys[1], inputs[input_keys[1]], fluid) / divisor

    # --- 4. Core ORC routine ---
    def calculate_orc_performance(...):
        # --- 3.1 Environmental reference state ---------------------------------
        # Fix: Change "H" to "HMASS", "S" to "SMASS"
        h0 = CP.PropsSI("HMASS", "T", T0, "P", P0, fluid) / 1e3  # kJ/kg
        s0 = CP.PropsSI("SMASS", "T", T0, "P", P0, fluid) / J_PER_KJ  # kJ/kg·K

        # --- 3.2 Thermodynamic states ------------------------------------------
        # Fix calls to _get_coolprop_property
        # (1) condenser outlet (sat. liquid)
        # P1 = _get_coolprop_property("P", fluid, T_K=T1, Q_frac=0) # P is fine
        # h1 = _get_coolprop_property("H", fluid, T_K=T1, Q_frac=0, divisor=J_PER_KJ) # Fix: "H" -> "HMASS"
        # s1 = _get_coolprop_property("S", fluid, T_K=T1, Q_frac=0, divisor=J_PER_KJ) # Fix: "S" -> "SMASS"

        # (2) pump outlet
        # h2s = _get_coolprop_property("H", fluid, P_Pa=P2, S_J_per_kgK=s2s * J_PER_KJ, divisor=J_PER_KJ) # Fix: "H" -> "HMASS"
        # T2  = _get_coolprop_property("T", fluid, P_Pa=P2, H_J_per_kg=h2 * J_PER_KJ) # T is fine
        # s2  = _get_coolprop_property("S", fluid, P_Pa=P2, H_J_per_kg=h2 * J_PER_KJ, divisor=J_PER_KJ) # Fix: "S" -> "SMASS"

        # (3) turbine inlet (superheated or sat. vapour)
        # h3 = _get_coolprop_property("H", fluid, T_K=T3, P_Pa=P3, divisor=J_PER_KJ) # Fix: "H" -> "HMASS"
        # s3 = _get_coolprop_property("S", fluid, T_K=T3, P_Pa=P3, divisor=J_PER_KJ) # Fix: "S" -> "SMASS"

        # (4) turbine outlet
        # h4s = _get_coolprop_property("H", fluid, P_Pa=P4, S_J_per_kgK=s4s * J_PER_KJ, divisor=J_PER_KJ) # Fix: "H" -> "HMASS"
        # T4  = _get_coolprop_property("T", fluid, P_Pa=P4, H_J_per_kg=h4 * J_PER_KJ) # T is fine
        # s4  = _get_coolprop_property("S", fluid, P_Pa=P4, H_J_per_kg=h4 * J_J_PER_KG, divisor=J_PER_KJ) # Fix: "S" -> "SMASS"

        # ... (apply these fixes to all calls to _get_coolprop_property in this function)
        # Example:
        h1 = _get_coolprop_property("HMASS", fluid, T_K=T1, Q_frac=0, divisor=J_PER_KJ)
        s1 = _get_coolprop_property("SMASS", fluid, T_K=T1, Q_frac=0, divisor=J_PER_KJ)
        # ... and so on for all state points

    # --- 5. Wrapper: match ORC to external heat source ---
    def calculate_orc_performance_from_heat_source(...):
        # Fix calls to _get_coolprop_property
        # P_evap = _get_coolprop_property("P", fluid_orc, T_K=T_sat_evap, Q_frac=1) # P is fine

        # h1 = _get_coolprop_property("H", fluid_orc, T_K=T1, Q_frac=0, divisor=J_PER_KJ) # Fix: "H" -> "HMASS"
        # s1 = _get_coolprop_property("S", fluid_orc, T_K=T1, Q_frac=0, divisor=J_PER_KJ) # Fix: "S" -> "SMASS"
        # h2s = _get_coolprop_property("H", fluid_orc, P_Pa=P_evap, S_J_per_kgK=s1 * J_J_PER_KG, divisor=J_PER_KJ) # Fix: "H" -> "HMASS"
        # h3 = _get_coolprop_property("H", fluid_orc, T_K=T_turb_in, P_Pa=P_evap, divisor=J_PER_KJ) # Fix: "H" -> "HMASS"

        # HTF properties
        # rho_htf = _get_coolprop_property("Dmass", fluid_htf, T_K=T_htf_in, P_Pa=P_htf) # Fix: "Dmass" -> "DMASS"
        # Cpm_htf = _get_coolprop_property("Cpmass", fluid_htf, T_K=T_htf_in, P_Pa=P_htf) # Fix: "Cpmass" -> "CPMASS"

        # ... (apply these fixes to all calls to _get_coolprop_property in this function)
        # Example:
        h1 = _get_coolprop_property("HMASS", fluid_orc, T_K=T1, Q_frac=0, divisor=J_PER_KJ)
        s1 = _get_coolprop_property("SMASS", fluid_orc, T_K=T1, Q_frac=0, divisor=J_PER_KJ)
        rho_htf = _get_coolprop_property("DMASS", fluid_htf, T_K=T_htf_in, P_Pa=P_htf)
        Cpm_htf = _get_coolprop_property("CPMASS", fluid_htf, T_K=T_htf_in, P_Pa=P_htf)
        # ... and so on.
    ```

*   **影響範囲:** この修正は CoolProp ライブラリとのインターフェース部分にのみ影響します。計算される熱力学的な状態量や、それに基づく性能値は変更されないはずです。主な目的は、将来の CoolProp バージョンとの互換性を確保することです。

---