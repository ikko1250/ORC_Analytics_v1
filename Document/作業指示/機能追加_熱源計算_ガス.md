# ガス熱源計算機能の実装

## 概要

ORC_analysis/heat_source.py に排ガス等のガス熱源に対応する計算ロジックを追加しました。

## 実装内容

### 1. 基本アプローチ

- **CoolProp単独方式**: 既存のliquid計算と同様のシンプルな構造を維持
- **混合ガス対応**: CoolPropの混合物機能を使用してガス組成を考慮
- **段階的実装**: まず基本機能を実装し、将来的にCantera等の高精度計算に拡張可能

### 2. 実装した機能

#### 2.1 ガス組成処理
- デフォルト組成: 天然ガス燃焼 (CO2: 11%, H2O: 20%, N2: 69%)
- カスタム組成対応: `gas_composition` パラメータで指定可能
- 組成妥当性チェック: 成分の合計が1.0になることを確認

#### 2.2 対応ガス成分
```python
coolprop_mapping = {
    "CO2": "CO2",
    "H2O": "Water", 
    "N2": "Nitrogen",
    "O2": "Oxygen",
    "SO2": "SulfurDioxide",
    "CO": "CarbonMonoxide"
}
```

#### 2.3 計算ロジック
1. **混合物文字列生成**: CoolProp形式の混合物文字列作成
2. **物性計算**: 密度(ρ)、比熱(Cp)をCoolPropで計算
3. **質量流量変換**: 体積流量→質量流量 (mass_flow_modeで直接指定も可能)
4. **利用可能熱量**: Q = ṁ × Cp × ΔT

### 3. 使用方法

```python
from ORC_analysis.heat_source import get_heat_source_profile

# 基本的な使用例（デフォルト組成）
profile = get_heat_source_profile(
    T_htf_in=773.15,  # 500°C
    Vdot_htf=1.0,     # 1 m3/s
    T_htf_out=393.15, # 120°C
    heat_source_type="gas"
)

# カスタム組成での使用例
steel_eaf_composition = {
    "CO2": 0.15,
    "H2O": 0.10,
    "N2": 0.70,
    "O2": 0.05
}

profile = get_heat_source_profile(
    T_htf_in=1473.15,  # 1200°C
    Vdot_htf=2.78,     # 10,000 Nm3/h → m3/s
    T_htf_out=423.15,  # 150°C
    heat_source_type="gas",
    gas_composition=steel_eaf_composition,
    P_gas=101325,      # ガス圧力 [Pa]
    mass_flow_mode=False,  # 体積流量指定
    T_gas_out_min=423.15   # 最低出口温度 [K]
)
```

### 4. パラメータ

#### 4.1 必須パラメータ
- `T_htf_in`: ガス入口温度 [K]
- `Vdot_htf`: 体積流量 [m3/s] または質量流量 [kg/s] (mass_flow_modeによる)
- `T_htf_out`: ガス出口温度 [K]
- `heat_source_type`: "gas"

#### 4.2 オプションパラメータ
- `gas_composition`: ガス組成辞書 (デフォルト: 天然ガス燃焼)
- `P_gas`: ガス圧力 [Pa] (デフォルト: 101325)
- `mass_flow_mode`: 質量流量指定モード (デフォルト: False)
- `T_gas_out_min`: 最低出口温度 [K] (デフォルト: T_htf_out)

### 5. 技術的制限事項

#### 5.1 現在の制限
- CoolPropで対応している成分のみ使用可能
- 混合物の相互作用パラメータはCoolPropのデフォルト値を使用
- 化学反応は考慮せず、物理的混合のみ

#### 5.2 将来の拡張可能性
- Cantera連携による高精度計算
- 化学平衡の考慮
- 温度依存比熱の積分計算
- より多くのガス成分への対応

### 6. エラーハンドリング

- 組成の合計値チェック (許容誤差: ±1%)
- CoolProp対応成分の確認
- 物性計算の例外処理
- 分かりやすいエラーメッセージ

### 7. 検証・テスト

基本的な動作確認は完了していますが、以下の検証が推奨されます:

1. **異なる組成での物性計算精度**
2. **温度範囲での計算安定性**
3. **実プロセスデータとの比較**

### 8. 既存機能への影響

- 既存のliquid、steamタイプの計算には影響なし
- HeatSourceProfileの構造は変更なし
- 後方互換性を完全に維持

## まとめ

シンプルで実用的なガス熱源計算機能を実装しました。プラン文書の複雑なCantera approach は将来の拡張として残し、まずは基本機能から開始することで、実用性と保守性を両立させています。