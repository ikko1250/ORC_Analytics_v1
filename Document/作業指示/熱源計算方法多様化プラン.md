# GitHub Issue #2: 熱源計算方法の多様化 - 変更プラン

## 🎯 課題の概要

現在のシステムは**温水の使用を前提**とした熱源計算のみに対応しており、産業排熱（排ガスなど）への対応ができていません。より高温域や多様な熱源タイプに対応するため、`calculate_orc_performance_from_heat_source`関数の拡張が必要です。

## 📋 提案する変更プラン

### **1. 新しい熱源計算方式の追加**

#### **1.1 熱量ベース計算方式の実装**
- **目的**: 直接的な熱量（kW）から計算する方式
- **対象**: バッファ付きシステムや蓄熱システム
- **新関数**: `calculate_orc_performance_from_heat_duty(Q_available, T_heat_source, ...)`

```python
def calculate_orc_performance_from_heat_duty(
    Q_available,           # 利用可能熱量 [kW]
    T_heat_source,         # 熱源温度 [K]
    T_cond,               # 凝縮温度 [K]
    eta_pump, eta_turb,   # 効率
    fluid_orc: str = DEFAULT_FLUID,
    superheat_C: float = 10.0,
    pinch_delta_K: float = 10.0,
    **kwargs
):
    """直接熱量指定によるORC性能計算"""
    pass
```

#### **1.2 排ガスベース計算方式の実装**
- **目的**: 排ガスの物性（温度、流量、組成）から計算
- **対象**: 電気アーク炉（EAF）などの工業プロセス
- **新関数**: `calculate_orc_performance_from_flue_gas(T_gas_in, m_gas, gas_composition, ...)`

```python
def calculate_orc_performance_from_flue_gas(
    T_gas_in,             # 排ガス入口温度 [K]
    m_gas,                # 排ガス質量流量 [kg/s]
    gas_composition,      # ガス組成 {"CO2": 0.15, "H2O": 0.10, "N2": 0.70, ...}
    T_cond,               # 凝縮温度 [K]
    eta_pump, eta_turb,   # 効率
    P_gas: float = 101325, # 排ガス圧力 [Pa]
    T_gas_out_min: float = None, # 最低排ガス温度制約 [K]
    **kwargs
):
    """排ガス物性に基づくORC性能計算"""
    pass
```

### **2. 既存関数の拡張とリファクタリング**

#### **2.1 `calculate_orc_performance_from_heat_source`の汎用化**

```python
def calculate_orc_performance_from_heat_source(
    # 既存パラメータ
    T_htf_in, Vdot_htf, T_cond, eta_pump, eta_turb,
    # 新規パラメータ
    heat_source_type: str = "liquid",      # "liquid", "high_pressure_water", "steam", "gas", "heat_duty"
    P_htf: float = 101325,                 # 熱源圧力 [Pa] (高圧水・蒸気の場合)
    gas_composition: dict = None,          # ガス組成 (heat_source_type="gas"の場合)
    Q_direct: float = None,               # 直接熱量指定 [kW]
    T_source_out: float = None,           # 熱源出口温度指定 [K]
    mass_flow_mode: bool = False,         # True: Vdot_htfを質量流量[kg/s]として解釈
    **kwargs
):
    """
    汎用熱源対応のORC性能計算
    
    Parameters:
    -----------
    heat_source_type : str
        熱源タイプ:
        - "liquid": 通常の低圧液体水 (< 100°C, 1 atm)
        - "high_pressure_water": 高圧過熱水 (> 100°C, > 1 atm)
        - "steam": 水蒸気 (ガス状態の水)
        - "gas": 一般的な排ガス
        - "heat_duty": 直接熱量指定
    P_htf : float
        熱源流体圧力 [Pa] (高圧水・蒸気の場合に重要)
    mass_flow_mode : bool
        True: Vdot_htfを質量流量[kg/s]として解釈
        False: Vdot_htfを体積流量[m3/s]として解釈
    """
    
    if heat_source_type == "liquid":
        # 通常の低圧液体水
        return _calculate_liquid_heat_source(T_htf_in, Vdot_htf, P_htf, ...)
        
    elif heat_source_type == "high_pressure_water":
        # 高圧過熱水（100°C以上の液体状態の水）
        return _calculate_high_pressure_water_heat_source(T_htf_in, P_htf, Vdot_htf, ...)
        
    elif heat_source_type == "steam":
        # 水蒸気（ガス状態の水）
        if mass_flow_mode:
            m_steam = Vdot_htf  # kg/s
        else:
            # 体積流量から質量流量に変換
            rho_steam = CP.PropsSI("DMASS", "T", T_htf_in, "P", P_htf, "Water")
            m_steam = Vdot_htf * rho_steam
        return _calculate_steam_heat_source(T_htf_in, P_htf, m_steam, ...)
        
    elif heat_source_type == "gas":
        # 一般的な排ガス
        if mass_flow_mode:
            m_gas = Vdot_htf  # kg/s
        else:
            # 体積流量から質量流量に変換（ガス組成を考慮）
            rho_gas = _get_flue_gas_properties(T_htf_in, gas_composition, P_htf)["rho"]
            m_gas = Vdot_htf * rho_gas
        return _calculate_gas_heat_source(T_htf_in, m_gas, gas_composition, ...)
        
    elif heat_source_type == "heat_duty":
        # 直接熱量指定
        return _calculate_direct_heat_duty(Q_direct, T_htf_in, T_source_out, ...)
        
    else:
        raise ValueError(f"Unknown heat_source_type: {heat_source_type}")
```

#### **2.2 熱源タイプ別の計算ロジック分離**

```python
def _calculate_liquid_heat_source(T_htf_in, Vdot_htf, T_cond, eta_pump, eta_turb, **kwargs):
    """現在の液体熱源計算ロジック（既存コードをリファクタリング）"""
    pass

def _calculate_gas_heat_source(T_gas_in, Vdot_gas, gas_composition, T_cond, eta_pump, eta_turb, **kwargs):
    """新規ガス熱源計算ロジック"""
    # ガス組成に基づく物性計算
    # 温度依存比熱の積分計算
    # 利用可能熱量の算出
    pass

def _calculate_direct_heat_duty(Q_available, T_source, T_source_out, T_cond, eta_pump, eta_turb, **kwargs):
    """新規熱量ベース計算ロジック"""
    # 直接指定された熱量からORC質量流量を逆算
    # 熱源出口温度制約の考慮
    pass
```

### **3. 排ガス物性計算の実装**

#### **3.1 Cantera + CoolProp ハイブリッド物性計算**

```python
import cantera as ct
import CoolProp.CoolProp as CP

class FlueGasProperties:
    """排ガス物性計算クラス（Cantera + CoolProp ハイブリッド）"""
    
    def __init__(self, gas_composition, calculation_method="hybrid"):
        """
        Parameters:
        -----------
        gas_composition : dict
            ガス組成 {"CO2": 0.15, "H2O": 0.10, "N2": 0.70, ...}
        calculation_method : str
            計算手法 ("cantera", "coolprop", "hybrid")
        """
        self.gas_composition = gas_composition
        self.method = calculation_method
        self._setup_calculation_engines()
    
    def _setup_calculation_engines(self):
        """計算エンジンの初期化"""
        # Cantera ガスオブジェクトの設定
        try:
            self.cantera_gas = ct.Solution('gri30.yaml')  # または適切なメカニズム
            self._set_cantera_composition()
        except Exception as e:
            print(f"Cantera initialization failed: {e}")
            self.cantera_gas = None
        
        # CoolProp用の組成文字列作成
        self._coolprop_mixture = self._create_coolprop_mixture_string()
    
    def _set_cantera_composition(self):
        """Canteraガスオブジェクトに組成を設定"""
        if self.cantera_gas:
            # Canteraの種名にマッピング
            cantera_mapping = {
                "CO2": "CO2", "H2O": "H2O", "N2": "N2", "O2": "O2",
                "SO2": "SO2", "CO": "CO", "NO": "NO", "NO2": "NO2"
            }
            
            cantera_composition = {}
            for species, fraction in self.gas_composition.items():
                if species in cantera_mapping and fraction > 0:
                    cantera_composition[cantera_mapping[species]] = fraction
            
            self.cantera_gas.X = cantera_composition
    
    def _create_coolprop_mixture_string(self):
        """CoolProp用の混合物文字列を作成"""
        coolprop_mapping = {
            "CO2": "CO2", "H2O": "Water", "N2": "Nitrogen", "O2": "Oxygen"
        }
        
        mixture_components = []
        for species, fraction in self.gas_composition.items():
            if species in coolprop_mapping and fraction > 0:
                mixture_components.append(f"{coolprop_mapping[species]}[{fraction}]")
        
        return "&".join(mixture_components)

def _get_flue_gas_properties(T_gas, gas_composition, P_gas=101325, method="hybrid"):
    """
    排ガスの物性値計算（Cantera + CoolProp ハイブリッド）
    
    Parameters:
    -----------
    T_gas : float
        ガス温度 [K]
    gas_composition : dict
        ガス組成 {"CO2": 0.15, "H2O": 0.10, "N2": 0.70, ...}
    P_gas : float
        ガス圧力 [Pa]
    method : str
        計算手法 ("cantera", "coolprop", "hybrid")
    
    Returns:
    --------
    dict
        物性値 {"rho": 密度, "Cp": 比熱, "h": エンタルピー, "s": エントロピー}
    """
    flue_gas = FlueGasProperties(gas_composition, method)
    
    if method == "cantera" and flue_gas.cantera_gas:
        return _calculate_properties_cantera(flue_gas.cantera_gas, T_gas, P_gas)
    elif method == "coolprop":
        return _calculate_properties_coolprop(flue_gas._coolprop_mixture, T_gas, P_gas)
    elif method == "hybrid":
        return _calculate_properties_hybrid(flue_gas, T_gas, P_gas)
    else:
        raise ValueError(f"Unknown calculation method: {method}")

def _calculate_properties_cantera(gas, T_gas, P_gas):
    """Canteraを使用した物性計算"""
    try:
        gas.TP = T_gas, P_gas
        
        return {
            "rho": gas.density,                    # kg/m3
            "Cp": gas.cp_mass,                     # J/kg/K
            "h": gas.enthalpy_mass,               # J/kg
            "s": gas.entropy_mass,                # J/kg/K
            "viscosity": gas.viscosity,           # Pa·s
            "thermal_conductivity": gas.thermal_conductivity,  # W/m/K
            "molecular_weight": gas.mean_molecular_weight,     # kg/kmol
            "method": "cantera"
        }
    except Exception as e:
        raise ValueError(f"Cantera calculation failed: {e}")

def _calculate_properties_coolprop(mixture_string, T_gas, P_gas):
    """CoolPropを使用した物性計算"""
    try:
        rho = CP.PropsSI("D", "T", T_gas, "P", P_gas, mixture_string)
        Cp = CP.PropsSI("C", "T", T_gas, "P", P_gas, mixture_string)
        h = CP.PropsSI("H", "T", T_gas, "P", P_gas, mixture_string)
        s = CP.PropsSI("S", "T", T_gas, "P", P_gas, mixture_string)
        
        return {
            "rho": rho,                           # kg/m3
            "Cp": Cp,                            # J/kg/K
            "h": h,                              # J/kg
            "s": s,                              # J/kg/K
            "method": "coolprop"
        }
    except Exception as e:
        raise ValueError(f"CoolProp calculation failed: {e}")

def _calculate_properties_hybrid(flue_gas, T_gas, P_gas):
    """ハイブリッド計算（Cantera + CoolProp）"""
    results = {}
    
    # 基本物性：Canteraを優先（高精度な熱化学計算）
    if flue_gas.cantera_gas:
        try:
            cantera_props = _calculate_properties_cantera(flue_gas.cantera_gas, T_gas, P_gas)
            results.update({
                "rho": cantera_props["rho"],
                "Cp": cantera_props["Cp"],
                "h": cantera_props["h"],
                "s": cantera_props["s"],
                "molecular_weight": cantera_props["molecular_weight"]
            })
        except Exception as e:
            print(f"Cantera calculation failed, fallback to CoolProp: {e}")
            # CoolPropにフォールバック
            coolprop_props = _calculate_properties_coolprop(flue_gas._coolprop_mixture, T_gas, P_gas)
            results.update(coolprop_props)
    
    # 輸送物性：可能であればCantera（分子動力学ベース）
    if flue_gas.cantera_gas:
        try:
            flue_gas.cantera_gas.TP = T_gas, P_gas
            results.update({
                "viscosity": flue_gas.cantera_gas.viscosity,
                "thermal_conductivity": flue_gas.cantera_gas.thermal_conductivity
            })
        except:
            # 輸送物性計算に失敗した場合はCoolPropまたは推算式
            results.update({
                "viscosity": _estimate_gas_viscosity(T_gas, flue_gas.gas_composition),
                "thermal_conductivity": _estimate_gas_thermal_conductivity(T_gas, flue_gas.gas_composition)
            })
    
    results["method"] = "hybrid"
    return results

def _calculate_gas_heat_capacity_integral(T_hot, T_cold, gas_composition, method="hybrid"):
    """
    温度依存比熱の積分計算
    
    Parameters:
    -----------
    T_hot, T_cold : float
        高温側・低温側温度 [K]
    gas_composition : dict
        ガス組成
    method : str
        計算手法
    
    Returns:
    --------
    float
        積分平均比熱 [J/kg/K]
    """
    if method == "cantera":
        return _integrate_cp_cantera(T_hot, T_cold, gas_composition)
    elif method == "coolprop":
        return _integrate_cp_coolprop(T_hot, T_cold, gas_composition)
    else:  # hybrid
        try:
            return _integrate_cp_cantera(T_hot, T_cold, gas_composition)
        except:
            return _integrate_cp_coolprop(T_hot, T_cold, gas_composition)

def _integrate_cp_cantera(T_hot, T_cold, gas_composition):
    """Canteraを使用した比熱積分"""
    flue_gas = FlueGasProperties(gas_composition)
    if not flue_gas.cantera_gas:
        raise ValueError("Cantera not available")
    
    # 温度点での比熱計算
    n_points = 20
    T_range = np.linspace(T_cold, T_hot, n_points)
    cp_values = []
    
    for T in T_range:
        flue_gas.cantera_gas.TP = T, 101325  # 標準圧力
        cp_values.append(flue_gas.cantera_gas.cp_mass)
    
    # 数値積分（台形公式）
    cp_integral = np.trapz(cp_values, T_range)
    cp_average = cp_integral / (T_hot - T_cold)
    
    return cp_average

def _estimate_gas_viscosity(T_gas, gas_composition):
    """ガス粘度の推算（Wilkeの混合則）"""
    # 簡易推算式（実装時には詳細な計算式を使用）
    base_viscosity = 2e-5 * (T_gas / 300) ** 0.7  # Pa·s
    return base_viscosity

def _estimate_gas_thermal_conductivity(T_gas, gas_composition):
    """ガス熱伝導度の推算"""
    # 簡易推算式（実装時には詳細な計算式を使用）
    base_conductivity = 0.03 * (T_gas / 300) ** 0.8  # W/m/K
    return base_conductivity
```

#### **3.2 排ガス特有の計算とデータベース**

```python
# 典型的な工業プロセス別ガス組成データベース（拡張版）
DEFAULT_GAS_COMPOSITIONS = {
    "steel_eaf": {
        "CO2": 0.15,
        "H2O": 0.10,
        "N2": 0.70,
        "O2": 0.05,
        "CO": 0.00,  # 燃焼完了想定
        "temperature_range": (1200, 1600),  # K
        "pressure_range": (101325, 120000), # Pa
        "typical_flow": (5000, 15000),      # Nm3/h
        "calculation_method": "hybrid"       # 推奨計算手法
    },
    "cement_kiln": {
        "CO2": 0.25,
        "H2O": 0.12,
        "N2": 0.58,
        "SO2": 0.03,
        "O2": 0.02,
        "temperature_range": (573, 673),    # K
        "pressure_range": (101325, 110000), # Pa
        "typical_flow": (180000, 220000),   # Nm3/h
        "calculation_method": "hybrid"
    },
    "natural_gas_combustion": {
        "CO2": 0.11,
        "H2O": 0.20,
        "N2": 0.69,
        "O2": 0.00,  # 完全燃焼想定
        "temperature_range": (473, 773),    # K
        "pressure_range": (101325, 105000), # Pa
        "typical_flow": (1000, 10000),     # Nm3/h
        "calculation_method": "coolprop"    # 単純組成のためCoolPropで十分
    },
    "coal_combustion": {
        "CO2": 0.14,
        "H2O": 0.08,
        "N2": 0.75,
        "SO2": 0.02,
        "O2": 0.01,
        "temperature_range": (473, 873),    # K
        "pressure_range": (101325, 110000), # Pa
        "typical_flow": (50000, 200000),   # Nm3/h
        "calculation_method": "cantera"     # SOx含有のためCanteraが適切
    },
    "biomass_combustion": {
        "CO2": 0.13,
        "H2O": 0.15,
        "N2": 0.70,
        "O2": 0.02,
        "temperature_range": (573, 1073),   # K
        "pressure_range": (101325, 105000), # Pa
        "typical_flow": (5000, 50000),     # Nm3/h
        "calculation_method": "hybrid"
    }
}

def get_default_gas_composition(process_type: str):
    """工業プロセス別のデフォルトガス組成を取得"""
    if process_type in DEFAULT_GAS_COMPOSITIONS:
        composition_data = DEFAULT_GAS_COMPOSITIONS[process_type].copy()
        # メタデータを除いて組成のみ抽出
        gas_composition = {k: v for k, v in composition_data.items() 
                          if isinstance(v, (int, float)) and k not in 
                          ["temperature_range", "pressure_range", "typical_flow"]}
        return gas_composition, composition_data
    else:
        # デフォルトとして天然ガス燃焼を使用
        return get_default_gas_composition("natural_gas_combustion")

def get_recommended_calculation_method(process_type: str, temperature: float):
    """プロセスタイプと温度に基づく推奨計算手法"""
    if process_type in DEFAULT_GAS_COMPOSITIONS:
        base_method = DEFAULT_GAS_COMPOSITIONS[process_type].get("calculation_method", "hybrid")
        
        # 高温域ではCanteraの精度が高い
        if temperature > 1000:  # K
            return "cantera" if base_method != "coolprop" else "hybrid"
        # 低温域ではCoolPropが安定
        elif temperature < 500:  # K
            return "coolprop" if base_method != "cantera" else "hybrid"
        else:
            return base_method
    else:
        return "hybrid"

def validate_gas_composition(gas_composition: dict, tolerance=0.01):
    """ガス組成の妥当性チェック"""
    total = sum(gas_composition.values())
    if abs(total - 1.0) > tolerance:
        raise ValueError(f"Gas composition sum ({total:.3f}) deviates from 1.0 by more than {tolerance}")
    
    # 負の値チェック
    for species, fraction in gas_composition.items():
        if fraction < 0:
            raise ValueError(f"Negative fraction for {species}: {fraction}")
    
    return True

def get_default_gas_composition(process_type: str):
    """工業プロセス別のデフォルトガス組成を取得"""
    return DEFAULT_GAS_COMPOSITIONS.get(process_type, DEFAULT_GAS_COMPOSITIONS["natural_gas_combustion"])
```

### **4. 高温・高圧対応の拡張**

#### **4.1 現在の制約と課題**

**現在のシステムの制約**:
- 熱源流体として**水（liquid Water）のみ**を想定
- **100°C未満の低圧条件**のみ対応（CoolPropで"Water"として液体状態）
- **高圧力下での100°C以上の水**（過熱水）に対応不可
- **水蒸気（steam）**には未対応

**新規対応が必要な熱源タイプ**:
1. **高圧過熱水**: 高圧力下で100°C以上の液体状態の水
2. **水蒸気（Steam）**: ガス状態の水蒸気
3. **過熱蒸気**: 飽和温度以上に加熱された水蒸気

#### **4.2 高圧過熱水対応の実装**

```python
def _calculate_high_pressure_water_heat_source(T_htf_in, P_htf, Vdot_htf, T_cond, eta_pump, eta_turb, **kwargs):
    """
    高圧過熱水の熱源計算
    
    Parameters:
    -----------
    T_htf_in : float
        過熱水入口温度 [K] (> 373.15K)
    P_htf : float
        水の圧力 [Pa] (> 101325Pa)
    Vdot_htf : float
        体積流量 [m3/s]
    """
    # 高圧水の状態確認
    if T_htf_in > 373.15 and P_htf > 101325:
        # CoolPropで高圧水の物性計算
        try:
            # 液体状態の確認
            phase = CP.PhaseSI("T", T_htf_in, "P", P_htf, "Water")
            if phase in ["liquid", "supercritical_liquid"]:
                # 高圧液体水として計算
                rho_htf = CP.PropsSI("DMASS", "T", T_htf_in, "P", P_htf, "Water")
                Cp_htf = CP.PropsSI("CPMASS", "T", T_htf_in, "P", P_htf, "Water")
                # 既存の液体計算ロジックを使用
                return _calculate_liquid_heat_source_core(T_htf_in, Vdot_htf, rho_htf, Cp_htf, ...)
            else:
                raise ValueError(f"Water at T={T_htf_in:.1f}K, P={P_htf:.0f}Pa is not in liquid phase: {phase}")
        except Exception as e:
            raise ValueError(f"High-pressure water property calculation failed: {e}")
    else:
        # 通常の低圧水として処理
        return _calculate_liquid_heat_source(T_htf_in, Vdot_htf, ...)
```

#### **4.3 水蒸気対応の実装（ガス熱源として）**

```python
def _calculate_steam_heat_source(T_steam_in, P_steam, m_steam, T_cond, eta_pump, eta_turb, **kwargs):
    """
    水蒸気熱源の計算（ガス熱源の一種として実装）
    
    Parameters:
    -----------
    T_steam_in : float
        蒸気入口温度 [K]
    P_steam : float
        蒸気圧力 [Pa]
    m_steam : float
        蒸気質量流量 [kg/s]
    """
    # 水蒸気組成（純粋な水蒸気）
    steam_composition = {"H2O": 1.0}
    
    # 蒸気の状態確認
    try:
        phase = CP.PhaseSI("T", T_steam_in, "P", P_steam, "Water")
        if phase not in ["gas", "supercritical_gas"]:
            raise ValueError(f"Water at T={T_steam_in:.1f}K, P={P_steam:.0f}Pa is not steam: {phase}")
        
        # 蒸気の物性計算
        rho_steam = CP.PropsSI("DMASS", "T", T_steam_in, "P", P_steam, "Water")
        Cp_steam = CP.PropsSI("CPMASS", "T", T_steam_in, "P", P_steam, "Water")
        h_steam_in = CP.PropsSI("HMASS", "T", T_steam_in, "P", P_steam, "Water")
        
        # 凝縮制約を考慮した出口温度設定
        T_sat_at_P = CP.PropsSI("T", "P", P_steam, "Q", 1, "Water")  # 飽和温度
        T_steam_out_min = max(T_sat_at_P + 10, 373.15)  # 凝縮防止のため+10K
        
        # ガス熱源計算ロジックを使用
        return _calculate_gas_heat_source_core(
            T_gas_in=T_steam_in,
            m_gas=m_steam,
            gas_composition=steam_composition,
            rho_gas=rho_steam,
            Cp_gas=Cp_steam,
            T_gas_out_min=T_steam_out_min,
            **kwargs
        )
        
    except Exception as e:
        raise ValueError(f"Steam property calculation failed: {e}")
```

#### **4.4 作動流体の自動選択機能**

```python
def select_optimal_working_fluid(T_heat_source, P_heat_source=101325, heat_source_type="liquid"):
    """
    熱源条件に応じた最適作動流体選択
    
    Parameters:
    -----------
    T_heat_source : float
        熱源温度 [K]
    P_heat_source : float
        熱源圧力 [Pa]
    heat_source_type : str
        熱源タイプ ("liquid", "gas", "steam", "heat_duty")
    
    Returns:
    --------
    str
        推奨作動流体名
    """
    # 水蒸気熱源の場合の特別処理
    if heat_source_type == "steam" or (heat_source_type == "gas" and "H2O" in gas_composition):
        if T_heat_source < 423.15:  # < 150°C
            return "R245fa"  # 低温蒸気
        elif T_heat_source < 523.15:  # < 250°C
            return "R1234ze"  # 中温蒸気
        else:  # > 250°C
            return "Toluene"  # 高温蒸気（水蒸気サイクルは避ける）
    
    # 通常の熱源の場合
    if T_heat_source < 373.15:  # < 100°C
        return "R245fa"
    elif T_heat_source < 423.15:  # < 150°C
        return "R1234ze"
    elif T_heat_source < 523.15:  # < 250°C
        return "Toluene"
    else:  # > 250°C
        return "Water"  # 水蒸気サイクル（非水蒸気熱源の場合のみ）
```

#### **4.5 温度・圧力範囲の拡張**

```python
# 高温・高圧域対応の設定
HIGH_TEMP_HIGH_PRESSURE_CONFIG = {
    "working_fluids": {
        "low_temp": ["R245fa", "R1234ze", "R134a"],           # < 150°C
        "mid_temp": ["Toluene", "Cyclohexane", "n-Pentane"],  # 150-300°C
        "high_temp": ["Water", "Therminol_VP1", "Dowtherm_A"] # > 300°C
    },
    "heat_source_types": {
        "low_pressure_water": {
            "temp_range": (293, 373),      # 20-100°C
            "pressure_range": (101325, 101325),  # 標準大気圧
            "phase": "liquid"
        },
        "high_pressure_water": {
            "temp_range": (373, 573),      # 100-300°C
            "pressure_range": (101325, 5e6),     # 1-50 bar
            "phase": "liquid"
        },
        "steam": {
            "temp_range": (373, 1073),     # 100-800°C
            "pressure_range": (101325, 10e6),    # 1-100 bar
            "phase": "gas"
        },
        "flue_gas": {
            "temp_range": (473, 1573),     # 200-1300°C
            "pressure_range": (101325, 300000),  # 1-3 bar
            "phase": "gas"
        }
    },
    "temperature_ranges": {
        "current": (70, 100),           # 現在の対応範囲 [°C]
        "extended_water": (70, 300),    # 高圧水拡張範囲 [°C]
        "extended_steam": (100, 800),   # 水蒸気対応範囲 [°C]
        "extended_gas": (200, 1300),    # 排ガス対応範囲 [°C]
        "supercritical": (374, 800)     # 超臨界対応範囲 [°C]
    }
}
```

### **5. 配置とファイル構成の変更**

#### **5.1 新しいモジュール構成**

```
ORC_analysis/
├── heat_sources/
│   ├── __init__.py
│   ├── liquid_heat_source.py    # 既存液体熱源
│   ├── gas_heat_source.py       # 新規ガス熱源
│   ├── direct_heat_duty.py      # 新規熱量ベース
│   └── heat_source_factory.py   # 熱源タイプ判定・選択
├── fluid_properties/
│   ├── __init__.py
│   ├── gas_mixtures.py          # ガス混合物物性
│   ├── high_temp_fluids.py      # 高温作動流体
│   └── fluid_selector.py        # 作動流体自動選択
├── database/
│   ├── __init__.py
│   ├── gas_compositions.py      # 工業プロセス別ガス組成
│   └── process_conditions.py    # 典型的なプロセス条件
└── ORC_Analysis.py              # メイン関数（リファクタリング）
```

#### **5.2 Plot_Template.pyの更新**

```python
# 新しい設定パラメータ
config = {
    "thermo_params": {
        # 既存パラメータ
        "T_cond_K": 305.0,
        "eta_pump": 0.40,
        "eta_turb": 0.80,
        "fluid_orc": DEFAULT_FLUID,
        "fluid_htf": "Water",
        "superheat_C": 8.0,
        "pinch_delta_K": 10.0,
        
        # 新規パラメータ
        "heat_source_type": "liquid",      # "liquid", "high_pressure_water", "steam", "gas", "heat_duty"
        "P_htf_Pa": 101325,               # 熱源圧力 [Pa]
        "mass_flow_mode": False,          # True: 質量流量指定, False: 体積流量指定
        "auto_fluid_selection": False,    # 自動流体選択
        "high_temp_mode": False,          # 高温モード
    },
    
    # 高圧水設定（heat_source_type="high_pressure_water"の場合）
    "high_pressure_water_params": {
        "pressure_Pa": 500000,            # 5 bar
        "max_temp_K": 573.15,            # 300°C
        "min_subcooling_K": 10.0,        # 過冷却度
    },
    
    # 水蒸気設定（heat_source_type="steam"の場合）
    "steam_params": {
        "pressure_Pa": 200000,            # 2 bar
        "superheat_degree_K": 50.0,      # 過熱度
        "condensation_prevention": True,   # 凝縮防止
        "min_outlet_temp_K": 383.15,     # 最低出口温度（110°C）
    },
    
    # 排ガス設定（heat_source_type="gas"の場合）
    "gas_params": {
        "process_type": "steel_eaf",      # プロセスタイプ
        "custom_composition": None,        # カスタム組成
        "gas_pressure_Pa": 101325,        # ガス圧力
        "min_outlet_temp_K": 393.15,      # 最低出口温度（120°C）
        "dew_point_consideration": True,   # 露点考慮
    },
    
    # 熱量ベース設定（heat_source_type="heat_duty"の場合）
    "heat_duty_params": {
        "Q_available_kW": 1000,           # 利用可能熱量
        "T_source_out_K": None,           # 熱源出口温度（指定可能）
        "heat_recovery_efficiency": 0.85, # 熱回収効率
    },
    
    # 既存の経済・スイープパラメータ
    "economic_params": { ... },
    "sweep_params": {
        "T_htf_min_C": 70,
        "T_htf_max_C": 300,              # 高温域まで拡張
        "n_T_points": 100,
        "Vdot_values_m3h": np.arange(20, 50 + 5, 5),
        "pressure_sweep": False,          # 圧力スイープの有無
        "P_values_bar": [1, 5, 10, 20],  # 圧力スイープ値
    },
    ...
}

# 使用例：高圧水の場合
if config["thermo_params"]["heat_source_type"] == "high_pressure_water":
    # 高圧水設定の適用
    thermo_cfg["P_htf_Pa"] = config["high_pressure_water_params"]["pressure_Pa"]
    sweep_cfg["T_htf_max_C"] = min(
        config["high_pressure_water_params"]["max_temp_K"] - 273.15,
        sweep_cfg["T_htf_max_C"]
    )

# 使用例：水蒸気の場合
elif config["thermo_params"]["heat_source_type"] == "steam":
    # 水蒸気設定の適用
    thermo_cfg["P_htf_Pa"] = config["steam_params"]["pressure_Pa"]
    thermo_cfg["mass_flow_mode"] = True  # 蒸気は通常質量流量で指定
    sweep_cfg["T_htf_min_C"] = 100       # 蒸気は100°C以上
```

### **6. 実装の段階的アプローチ**

#### **Phase 1: 基盤整備 (Week 1-2)**
1. **既存コードのリファクタリング**
   - `calculate_orc_performance_from_heat_source`の分割
   - 熱源タイプ判定機能の実装
   - 基本的なエラーハンドリング強化

2. **Cantera + CoolProp ハイブリッド物性計算の基盤構築**
   - `FlueGasProperties`クラスの実装
   - Canteraガスオブジェクトの初期化ロジック
   - CoolProp混合物文字列の生成機能
   - 基本的な物性計算関数（密度、比熱、エンタルピー）

3. **排ガス組成データベースの構築**
   - 工業プロセス別ガス組成データ
   - 推奨計算手法の決定ロジック
   - 組成妥当性チェック機能

#### **Phase 2: 排ガス対応 (Week 3-4)**
1. **高精度排ガス計算ロジックの実装**
   - `_calculate_gas_heat_source`関数（Cantera/CoolPropハイブリッド）
   - 温度依存比熱の積分計算（数値積分）
   - 輸送物性（粘度、熱伝導度）の計算・推算
   - 化学平衡計算（Canteraの高度機能活用）

2. **排ガス特有の制約条件対応**
   - 露点計算（H2O凝縮防止）
   - 酸露点計算（SOx含有ガス対応）
   - 腐食限界温度の考慮
   - 最適計算手法の自動選択

3. **計算精度の検証・ベンチマーク**
   - 文献値との比較検証
   - Cantera vs CoolPropの精度比較
   - 計算速度の最適化

#### **Phase 3: 統合・最適化 (Week 5-6)**
1. **熱量ベース計算の実装**
   - `_calculate_direct_heat_duty`関数
   - バッファシステム設計支援
   - 不確実性解析機能（Monte Carlo法）

2. **自動流体選択機能の高度化**
   - 排ガス組成を考慮した作動流体選択
   - 性能・経済性の多目的最適化
   - 超臨界サイクル対応検討

3. **包括的なテスト・検証**
   - 実プロセスデータでの検証
   - 計算精度のベンチマーク
   - 性能・メモリ使用量の最適化

### **Cantera + CoolProp ハイブリッドアプローチの利点**

#### **計算精度の向上**
- **Cantera**: 高温域での化学平衡計算、詳細な熱化学データ
- **CoolProp**: 安定した状態方程式、広い温度・圧力範囲
- **ハイブリッド**: 各手法の長所を組み合わせた最適計算

#### **対応範囲の拡張**
- **複雑なガス組成**: SOx, NOx, 未燃成分を含む実際の排ガス
- **化学反応考慮**: 高温域での解離・再結合反応
- **輸送物性**: 分子動力学ベースの粘度・熱伝導度計算

#### **実用性の向上**
- **自動フォールバック**: 一方の計算が失敗した場合の代替手法
- **計算手法選択**: プロセス・温度に応じた最適手法の自動選択
- **エラーハンドリング**: 堅牢な例外処理とエラー回復

### **7. 技術的課題と対策**

#### **7.1 流量不明問題への対応**
**Issue記載の課題**: 排ガス・高圧温水の流量が不明

**対策**:
```python
# 1. 典型的な工業プロセス別のデフォルト値データベース
TYPICAL_PROCESS_CONDITIONS = {
    "steel_eaf_100t": {
        "gas_flow_range": (5000, 15000),  # Nm3/h
        "temp_range": (1200, 1600),       # K
        "heat_content": (50, 150)         # MJ/t-steel
    },
    "cement_kiln_1000tpd": {
        "gas_flow_range": (180000, 220000),  # Nm3/h
        "temp_range": (573, 673),            # K
        "heat_content": (1.8, 2.2)          # GJ/t-cement
    }
}

# 2. 熱量+温度から逆算する機能
def estimate_flow_from_heat_duty(Q_available, T_in, T_out, gas_composition):
    """熱量と温度差から流量を逆算"""
    pass

# 3. 不確実性解析機能
def uncertainty_analysis(base_conditions, uncertainty_ranges):
    """パラメータ不確実性を考慮したMonte Carlo解析"""
    pass
```

#### **7.2 EAFの変動性への対応**
**Issue記載の課題**: 生産サイクルが不定、温度・流量にばらつき

**対策**:
```python
# 1. バッファタンク設計機能
def design_thermal_buffer(
    heat_profile,          # 時間変動熱プロファイル
    target_steady_output,  # 目標定常出力
    buffer_medium="molten_salt"  # バッファ媒体
):
    """蓄熱バッファシステムの設計"""
    pass

# 2. 変動パターン解析
def analyze_heat_variability(
    time_series_data,      # 時系列データ
    analysis_period="daily" # 解析期間
):
    """熱源変動パターンの統計解析"""
    pass

# 3. 蓄熱システム連携機能
def integrate_thermal_storage(
    orc_design,           # ORC設計パラメータ
    storage_config,       # 蓄熱システム設定
    operation_strategy    # 運転戦略
):
    """蓄熱システム統合設計"""
    pass
```

### **8. 使用例とテストケース**

#### **8.1 高精度排ガスケースの使用例**

```python
# 電気アーク炉排ガスの例（Cantera高精度計算）
eaf_result = calculate_orc_performance_from_heat_source(
    T_htf_in=1473.15,  # 1200°C
    Vdot_htf=2.78,     # 10,000 Nm3/h → m3/s (標準状態)
    T_cond=305.15,     # 32°C
    eta_pump=0.75,
    eta_turb=0.85,
    heat_source_type="gas",
    gas_composition={
        "CO2": 0.15,
        "H2O": 0.10,
        "N2": 0.70,
        "O2": 0.05
    },
    calculation_method="cantera",  # 高温域のため高精度計算
    fluid_orc="Water",  # 高温のため水蒸気サイクル
    superheat_C=50.0,
    pinch_delta_K=30.0,
    min_outlet_temp_K=423.15,  # 150°C（腐食防止）
    P_htf=101325,
    mass_flow_mode=True  # 質量流量で指定
)

# セメントキルン排ガスの例（SOx含有、ハイブリッド計算）
cement_result = calculate_orc_performance_from_heat_source(
    T_htf_in=623.15,   # 350°C
    Vdot_htf=55.56,    # 200,000 Nm3/h → m3/s
    T_cond=305.15,     # 32°C
    eta_pump=0.70,
    eta_turb=0.82,
    heat_source_type="gas",
    process_type="cement_kiln",  # プリセット組成使用
    calculation_method="hybrid",  # SOx含有のためCantera+CoolProp
    fluid_orc="R1234ze",  # 中温域用有機流体
    superheat_C=15.0,
    pinch_delta_K=20.0,
    min_outlet_temp_K=393.15,  # 120°C（酸露点考慮）
    dew_point_analysis=True,   # 露点解析実行
    corrosion_analysis=True    # 腐食解析実行
)

# 天然ガス燃焼排ガスの例（CoolProp単独計算）
ng_result = calculate_orc_performance_from_heat_source(
    T_htf_in=573.15,   # 300°C
    Vdot_htf=1.39,     # 5,000 Nm3/h → m3/s
    T_cond=305.15,     # 32°C
    eta_pump=0.75,
    eta_turb=0.85,
    heat_source_type="gas",
    process_type="natural_gas_combustion",
    calculation_method="coolprop",  # 単純組成のためCoolPropで十分
    fluid_orc="Toluene",
    superheat_C=20.0,
    pinch_delta_K=15.0
)
```

#### **8.2 計算手法比較とベンチマーク例**

```python
# 同一条件での計算手法比較
def compare_calculation_methods(T_gas, gas_composition, P_gas=101325):
    """異なる計算手法での物性値比較"""
    
    methods = ["cantera", "coolprop", "hybrid"]
    results = {}
    
    for method in methods:
        try:
            props = _get_flue_gas_properties(T_gas, gas_composition, P_gas, method)
            results[method] = {
                "density": props["rho"],
                "cp": props["Cp"],
                "enthalpy": props["h"],
                "calculation_time": time.time() - start_time
            }
        except Exception as e:
            results[method] = {"error": str(e)}
    
    return results

# 使用例
steel_eaf_composition = {
    "CO2": 0.15, "H2O": 0.10, "N2": 0.70, "O2": 0.05
}

comparison = compare_calculation_methods(
    T_gas=1473.15,  # 1200°C
    gas_composition=steel_eaf_composition
)

print("計算手法比較結果:")
for method, result in comparison.items():
    if "error" not in result:
        print(f"{method}: ρ={result['density']:.3f} kg/m³, "
              f"Cp={result['cp']:.1f} J/kg/K, "
              f"計算時間={result['calculation_time']:.4f}s")
    else:
        print(f"{method}: エラー - {result['error']}")
```

#### **8.3 複雑な排ガス組成での高精度計算例**

```python
# 石炭燃焼排ガス（SOx, NOx含有）
coal_flue_gas = {
    "CO2": 0.14,
    "H2O": 0.08,
    "N2": 0.75,
    "SO2": 0.015,  # 硫黄酸化物
    "NO": 0.003,   # 窒素酸化物
    "O2": 0.012
}

coal_result = calculate_orc_performance_from_heat_source(
    T_htf_in=773.15,   # 500°C
    Vdot_htf=27.78,    # 100,000 Nm3/h → m3/s
    T_cond=305.15,
    eta_pump=0.75,
    eta_turb=0.85,
    heat_source_type="gas",
    gas_composition=coal_flue_gas,
    calculation_method="cantera",  # SOx/NOx含有のためCantera必須
    fluid_orc="Cyclohexane",
    superheat_C=25.0,
    pinch_delta_K=25.0,
    min_outlet_temp_K=403.15,  # 130°C（酸露点+安全マージン）
    acid_dew_point_analysis=True,  # 酸露点解析
    chemical_equilibrium=True,     # 化学平衡考慮
    detailed_output=True           # 詳細出力
)

# バイオマス燃焼排ガス（可変組成）
biomass_variable_composition = {
    "CO2": 0.13,
    "H2O": 0.15,   # 高水分
    "N2": 0.70,
    "O2": 0.02,
    "CO": 0.001,   # 未燃成分わずか
    "tar_compounds": 0.009  # タール成分（Canteraで近似計算）
}

biomass_result = calculate_orc_performance_from_heat_source(
    T_htf_in=873.15,   # 600°C
    Vdot_htf=13.89,    # 50,000 Nm3/h → m3/s
    T_cond=305.15,
    eta_pump=0.70,
    eta_turb=0.80,
    heat_source_type="gas",
    gas_composition=biomass_variable_composition,
    calculation_method="hybrid",
    fluid_orc="Toluene",
    superheat_C=30.0,
    pinch_delta_K=20.0,
    uncertainty_analysis=True,     # 不確実性解析
    composition_sensitivity=True,  # 組成感度解析
    fouling_consideration=True     # ファウリング考慮
)
```

#### **8.2 熱量ベースケースの使用例**

```python
# バッファ付きシステムの例
buffer_result = calculate_orc_performance_from_heat_source(
    Q_direct=5000,      # 5 MW熱量
    T_htf_in=473.15,    # 200°C
    T_cond=305.15,      # 32°C
    eta_pump=0.75,
    eta_turb=0.85,
    heat_source_type="heat_duty",
    T_source_out=393.15, # 120°C出口温度
    fluid_orc="Toluene", # 中温域用有機流体
    superheat_C=20.0,
    pinch_delta_K=15.0
)
```

### **9. 期待される効果**

#### **9.1 対応範囲の拡大**
- **温水のみ** → **温水 + 排ガス + 熱量ベース**
- **70-100°C** → **70-500°C以上**
- **単一流体** → **自動最適流体選択**

#### **9.2 精度向上**
- 実際の工業プロセスに即した物性計算
- 温度依存比熱の積分計算
- プロセス特有の制約条件考慮

#### **9.3 使いやすさ**
- 流量不明ケースでも使用可能
- 典型的な工業プロセス用プリセット
- 不確実性解析による信頼性評価

#### **9.4 拡張性**
- 新しい熱源タイプの追加が容易
- 作動流体データベースの拡張可能
- 将来的な超臨界サイクル対応

### **10. まとめ**

この変更により、ORC解析システムは以下のように発展します：

1. **多様な熱源への対応**: 温水、排ガス、直接熱量指定
2. **高温域への拡張**: 500°C以上の工業排熱への対応
3. **実用性の向上**: 流量不明ケースや変動熱源への対応
4. **自動化機能**: 最適流体選択、プロセス別プリセット
5. **信頼性向上**: 不確実性解析、バッファシステム設計

これにより、産業排熱回収のためのORC導入検討が、より現実的で包括的に行えるようになることが期待されます。

---

*このプランは段階的な実装を想定しており、既存機能への影響を最小限に抑えながら、新機能を追加していく方針です。*
